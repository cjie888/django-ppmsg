{% extends "base.html" %} 
{% load icon %} 
{% load url from future %} 
{% load breadcrumb %}
{% block content %}
<style type="text/css">
.arrow_box_left {
	position: relative;
	background: #f2f2f2;
	border: 1px solid #ffffff;
}
.arrow_box_left:before {
	right: 100%;
	top: 50%;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
	border-right-color: #f2f2f2;
	border-width: 10px;
	margin-top: -10px;
}

.arrow_box_right {
    position: relative;
    background: #f2f2f2;
    border: 1px solid #ffffff;
}
.arrow_box_right:after {
    left: 100%;
    top: 50%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
	border-color: rgba(208, 213, 198, 0);
    border-left-color: #f2f2f2;
    border-width: 10px;
    margin-top: -10px;
}
</style>
{% breadcrumb breadcrumb request %}
{% if message_list %} 
	<ul class="media-list">
	{% for message in message_list %}
			<li class="media" id="{{message.id}}#message">
				{% if message.sender.username == session_user.username %}
                    <div class="col-xs-1 col-md-1"></div>
					<div class="col-xs-10 col-md-10 arrow_box_right">
						<div>
							<span>&nbsp;</span>	
							<span class="pull-right">
							{% if message.read_at == None and message.sender.username == session_user.username %}
								<FONT COLOR="#0000ff">N</FONT><FONT COLOR="#A500ff">e</FONT><FONT COLOR="#FF00B4">w</FONT>&nbsp;&nbsp;&nbsp;
							{% endif %}
							<small class="text-muted">{{message.sent_at|timesince}}前</small>
							</span>
						</div>
						<div id="{{message.sender.id}}message" class="text-right">{{message.content}}&nbsp;&nbsp;&nbsp;</div>
						<div class="text-right">
					    <a class="btn btn-default btn-xs"  href="#delmsgModal" data-toggle="modal" onclick='msg_del("{{message.id}}", "{{message.content|escapejs}}")'>删除</a>
						</div>
					</div>
                    <div class="col-xs-1 col-md-1">{% usericon message.sender 60 "#" %}</div>
				{% else %}
					<div class="col-xs-1 col-md-1">{% usericon message.sender 60 "#" %}</div>
					<div class="col-xs-10 col-md-10 arrow_box_left">
                        <div>
                            <span class="pull-center"><small class="text-muted">&nbsp;&nbsp;&nbsp;{{message.sent_at|timesince}}前</small>
                            </span>
                        </div>
                        <div id="{{message.sender.id}}message" class="text-left">&nbsp;&nbsp;{{message.content}}</div>
                        <div class="text-right">
                        <a class="btn btn-default btn-xs"  href="#delmsgModal" data-toggle="modal" onclick='msg_del("{{message.id}}", "{{message.content|escapejs}}")'>删除</a>
                        </div>
					</div>
                    <div class="col-xs-1 col-md-1"></div>
				{% endif %}
				<div style="margin-top: 10px"></div>
			</li>
	{% endfor %} 
	</ul>
	<!-- DelmsgModal -->
    <div class="modal fade" id="delmsgModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="myModalLabel">删除私信</h3>
                </div>
                <div class="modal-body" id='del_msg'>
                    <p id='del_msg_info'></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="del_msg_yes">确定</button>
                </div>
             </div>
         </div>
     </div>
 
    <!-- endDelmsgModal -->
{% else %}
	<p>您目前没有私信</p>
{% endif %} 
<script type="text/javascript">
  function msg_del(id, msg)
  {  
      $('#delmsgModal').on('show.bs.modal',function(){
          $('#del_msg_info').html('确定要删除该条私信?')
          $("#del_msg_yes").data('delmsg', msg);
          $("#del_msg_yes").data('eid', id);
      })
  }
  $("#del_msg_yes").click(function(){
      var msg = $("#del_msg_yes").data('delmsg');
      var eid = $("#del_msg_yes").data('eid');
      $.ajax({
          url : '/msg/delete/' + eid + '/', 
          datatype:"json",
          success:function(data) {
              data = eval(data)
              if(data.status == "ok"){
                  $('#del_msg_info').html(data.msg);
                  window.location.href = "{{request.get_full_path}}";
              }else{
                  $('#del_msg_info').html(data.msg);
              }
              setTimeout("$('#delmsgModal').modal('hide')", 500);
          }
      });
  })
  function set_read(user) {
      $.ajax({
          url : '/msg/set_read/' + user + '/', 
          datatype:"json",
          success:function(data) {
              data = eval(data)
              if(data.status == "ok"){
            	  console.log('设置成功')
              } else {
            	  console.log('设置失败')
              }
              
          }
      });
  }
  set_read('{{session_user}}')
</script>
{% endblock %}
